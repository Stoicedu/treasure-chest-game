<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasure Chest Adventure Game - Risk and Reward Learning</title>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        /* Treasure Chest Adventure Game - Kid-Friendly Styles */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Neue', cursive;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Background Animation */
        .floating-treasures {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .floating-treasures i {
            position: absolute;
            color: rgba(255, 215, 0, 0.3);
            font-size: 2rem;
            animation: float 6s ease-in-out infinite;
        }

        .floating-treasures i:nth-child(1) {
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }

        .floating-treasures i:nth-child(2) {
            top: 20%;
            right: 10%;
            animation-delay: 1s;
        }

        .floating-treasures i:nth-child(3) {
            top: 70%;
            left: 5%;
            animation-delay: 2s;
        }

        .floating-treasures i:nth-child(4) {
            bottom: 20%;
            right: 20%;
            animation-delay: 3s;
        }

        .floating-treasures i:nth-child(5) {
            bottom: 10%;
            left: 50%;
            animation-delay: 4s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }

        /* Main Container */
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* Header */
        .game-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .game-title {
            font-size: 2.5rem;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }

        .game-subtitle {
            font-size: 1.2rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* Game Settings */
        .game-settings {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .difficulty-selector label {
            font-weight: bold;
            color: #333;
            margin-right: 10px;
        }

        .difficulty-selector select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 2px solid #ddd;
            font-family: inherit;
            font-size: 1rem;
            background: white;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #ffecd2, #fcb69f);
            color: #333;
        }

        .btn-reset {
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Game Stats */
        .game-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-item {
            background: linear-gradient(45deg, #a8edea, #fed6e3);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }

        /* Game Instructions */
        .instructions {
            background: linear-gradient(45deg, #ffecd2, #fcb69f);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .instructions h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .instructions p {
            color: #555;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        /* Treasure Chests */
        .treasure-chests {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chest-container {
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .chest-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .treasure-chest {
            position: relative;
            width: 120px;
            height: 100px;
            margin: 0 auto 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chest-lid {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 40px;
            background: linear-gradient(45deg, #d4af37, #ffd700);
            border-radius: 15px 15px 5px 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #8b4513;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.5s ease;
            z-index: 2;
        }

        .chest-body {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 110px;
            height: 70px;
            background: linear-gradient(45deg, #8b4513, #a0522d);
            border-radius: 10px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.3);
        }

        .chest-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 120px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .treasure-chest:hover .chest-glow {
            opacity: 1;
        }

        .treasure-chest.opening .chest-lid {
            transform: translateX(-50%) rotateX(-120deg);
            transform-origin: bottom;
        }

        .treasure-chest.opening .chest-glow {
            opacity: 1;
            animation: pulse 1s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }

        .chest-info h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .chest-description {
            color: #666;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .chest-probability {
            color: #4ecdc4;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .chest-reward {
            color: #ff6b6b;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .chest-button {
            padding: 12px 25px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            font-family: inherit;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chest-button:hover {
            background: linear-gradient(45deg, #764ba2, #667eea);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .chest-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Result Display */
        .result-display {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .result-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            animation: slideIn 0.5s ease;
            position: relative;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .result-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .result-content h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.8rem;
        }

        .result-content p {
            color: #666;
            margin-bottom: 20px;
            font-size: 1.2rem;
            line-height: 1.5;
        }

        .reward-display {
            margin: 20px 0;
            font-size: 1.5rem;
        }

        .reward-item {
            display: inline-block;
            margin: 5px;
            padding: 10px 15px;
            background: linear-gradient(45deg, #ffd700, #ffed4a);
            color: #333;
            border-radius: 15px;
            font-weight: bold;
            animation: rewardPop 0.6s ease-out;
            transform-origin: center;
        }

        @keyframes rewardPop {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(-90deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(0) scale(1) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(0.5) rotate(360deg);
                opacity: 0;
            }
        }

        /* Reflection Section */
        .reflection-section {
            background: linear-gradient(45deg, #e0c3fc, #9bb5ff);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .reflection-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .reflection-question {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: #333;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .reflection-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Game History */
        .game-history {
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .game-history h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            border-left: 4px solid;
        }

        .history-item.success {
            border-left-color: #28a745;
        }

        .history-item.empty {
            border-left-color: #dc3545;
        }

        .history-item.safe {
            border-left-color: #ffc107;
        }

        .no-history {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        /* Footer */
        .game-footer {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .game-footer p {
            margin-bottom: 5px;
        }

        /* Tutorial Styles */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .tutorial-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: slideIn 0.5s ease;
        }

        .tutorial-steps {
            margin: 30px 0;
        }

        .tutorial-step {
            display: flex;
            align-items: center;
            margin: 15px 0;
            text-align: left;
        }

        .step-number {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .game-container {
                padding: 15px;
            }
            
            .game-title {
                font-size: 2rem;
            }
            
            .treasure-chests {
                grid-template-columns: 1fr;
            }
            
            .game-settings {
                flex-direction: column;
                align-items: center;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .chest-container {
                padding: 20px;
            }
            
            .treasure-chest {
                width: 100px;
                height: 85px;
            }
            
            .chest-lid {
                width: 85px;
                height: 35px;
                font-size: 1.5rem;
            }
            
            .chest-body {
                width: 95px;
                height: 60px;
            }
            
            .result-content {
                padding: 25px;
            }
            
            .result-icon {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Header -->
        <header class="game-header">
            <h1 class="game-title">
                <i class="fas fa-treasure-chest"></i>
                Treasure Chest Adventure
            </h1>
            <p class="game-subtitle">Learn about Risk and Reward! 🏆</p>
        </header>

        <!-- Game Settings -->
        <div class="game-settings">
            <div class="difficulty-selector">
                <label for="difficulty">Difficulty Level:</label>
                <select id="difficulty">
                    <option value="beginner">Beginner (Ages 5-7)</option>
                    <option value="standard" selected>Standard (Ages 7-9)</option>
                    <option value="advanced">Advanced (Ages 9-11)</option>
                </select>
            </div>
            <div class="control-buttons">
                <button id="sound-toggle" class="btn btn-secondary">
                    <i class="fas fa-volume-up"></i> Sound
                </button>
                <button id="reset-game" class="btn btn-reset">
                    <i class="fas fa-redo"></i> New Game
                </button>
            </div>
        </div>

        <!-- Game Stats -->
        <div class="game-stats">
            <div class="stat-item">
                <div class="stat-label">Round</div>
                <div class="stat-value" id="round-counter">1</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Score</div>
                <div class="stat-value" id="total-score">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Treasures Found</div>
                <div class="stat-value" id="treasures-found">0</div>
            </div>
        </div>

        <!-- Game Instructions -->
        <div class="instructions" id="instructions">
            <h3><i class="fas fa-info-circle"></i> How to Play</h3>
            <p id="instruction-text">Choose one treasure chest! Each chest has different rewards and probabilities.</p>
        </div>

        <!-- Treasure Chests -->
        <div class="treasure-chests">
            <div class="chest-container">
                <div class="treasure-chest" id="chest-1" data-chest="1">
                    <div class="chest-lid">
                        <i class="fas fa-treasure-chest"></i>
                    </div>
                    <div class="chest-body"></div>
                    <div class="chest-glow"></div>
                </div>
                <div class="chest-info">
                    <h3>Safe Harbor 🛡️</h3>
                    <p class="chest-description">Small treasure (guaranteed)</p>
                    <p class="chest-probability">Success Rate: 100%</p>
                    <p class="chest-reward">Reward: 1 Small Treasure</p>
                </div>
                <button class="chest-button" data-chest="1">Choose</button>
            </div>

            <div class="chest-container">
                <div class="treasure-chest" id="chest-2" data-chest="2">
                    <div class="chest-lid">
                        <i class="fas fa-treasure-chest"></i>
                    </div>
                    <div class="chest-body"></div>
                    <div class="chest-glow"></div>
                </div>
                <div class="chest-info">
                    <h3>Balanced Adventure ⚖️</h3>
                    <p class="chest-description">Large treasure or empty chest</p>
                    <p class="chest-probability">Success Rate: 50%</p>
                    <p class="chest-reward">Reward: 1 Large Treasure or Nothing</p>
                </div>
                <button class="chest-button" data-chest="2">Choose</button>
            </div>

            <div class="chest-container">
                <div class="treasure-chest" id="chest-3" data-chest="3">
                    <div class="chest-lid">
                        <i class="fas fa-treasure-chest"></i>
                    </div>
                    <div class="chest-body"></div>
                    <div class="chest-glow"></div>
                </div>
                <div class="chest-info">
                    <h3>Big Challenge 🎯</h3>
                    <p class="chest-description">Two large treasures or empty chest</p>
                    <p class="chest-probability">Success Rate: 30%</p>
                    <p class="chest-reward">Reward: 2 Large Treasures or Nothing</p>
                </div>
                <button class="chest-button" data-chest="3">Choose</button>
            </div>
        </div>

        <!-- Result Display -->
        <div class="result-display" id="result-display" style="display: none;">
            <div class="result-content">
                <div class="result-icon" id="result-icon"></div>
                <h2 id="result-title"></h2>
                <p id="result-description"></p>
                <div class="reward-display" id="reward-display"></div>
                <button id="continue-game" class="btn btn-primary">Next Round</button>
            </div>
        </div>

        <!-- Reflection Questions -->
        <div class="reflection-section" id="reflection-section" style="display: none;">
            <h3><i class="fas fa-lightbulb"></i> Think About It</h3>
            <div class="reflection-question" id="reflection-question"></div>
            <div class="reflection-buttons">
                <button class="btn btn-secondary" onclick="showReflection()">Another Question</button>
                <button class="btn btn-primary" onclick="hideReflection()">Continue</button>
            </div>
        </div>

        <!-- Game History -->
        <div class="game-history">
            <h3><i class="fas fa-history"></i> Game History</h3>
            <div class="history-list" id="history-list">
                <p class="no-history">No history yet. Choose your first chest!</p>
            </div>
        </div>

        <!-- Footer -->
        <footer class="game-footer">
            <p>🎓 Learning Goals: Decision-making, Probability Understanding, Emotional Regulation</p>
            <p>📚 Learning Elements: Risk vs Reward, Basic Probability Concepts, Pattern Recognition</p>
        </footer>
    </div>

    <!-- Background Elements -->
    <div class="floating-treasures">
        <i class="fas fa-coins"></i>
        <i class="fas fa-gem"></i>
        <i class="fas fa-star"></i>
        <i class="fas fa-crown"></i>
        <i class="fas fa-medal"></i>
    </div>

    <script>
        // Treasure Chest Adventure Game - Sound Effects System
        class GameSounds {
            constructor() {
                this.audioContext = null;
                this.sounds = {};
                this.enabled = true;
                
                this.init();
            }
            
            async init() {
                try {
                    // Initialize Web Audio API
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.createSounds();
                } catch (error) {
                    console.log('Could not initialize audio context:', error);
                    this.enabled = false;
                }
            }
            
            createSounds() {
                // Chest opening sound
                this.sounds.chestOpen = this.createChestOpenSound();
                
                // Success sound
                this.sounds.success = this.createSuccessSound();
                
                // Fail sound
                this.sounds.fail = this.createFailSound();
                
                // Treasure discovery sound
                this.sounds.treasure = this.createTreasureSound();
                
                // Button click sound
                this.sounds.click = this.createClickSound();
                
                // Celebration sound
                this.sounds.celebration = this.createCelebrationSound();
            }
            
            createChestOpenSound() {
                return () => {
                    if (!this.enabled || !this.audioContext) return;
                    
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    // Chest opening sound (low to high frequency)
                    oscillator.frequency.setValueAtTime(200, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(800, this.audioContext.currentTime + 0.3);
                    
                    gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.2, this.audioContext.currentTime + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
                    
                    oscillator.type = 'triangle';
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 0.5);
                };
            }
            
            createSuccessSound() {
                return () => {
                    if (!this.enabled || !this.audioContext) return;
                    
                    // Success melody (C-E-G)
                    const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5
                    
                    frequencies.forEach((freq, index) => {
                        setTimeout(() => {
                            const oscillator = this.audioContext.createOscillator();
                            const gainNode = this.audioContext.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(this.audioContext.destination);
                            
                            oscillator.frequency.value = freq;
                            oscillator.type = 'sine';
                            
                            gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                            gainNode.gain.linearRampToValueAtTime(0.3, this.audioContext.currentTime + 0.05);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
                            
                            oscillator.start();
                            oscillator.stop(this.audioContext.currentTime + 0.3);
                        }, index * 150);
                    });
                };
            }
            
            createFailSound() {
                return () => {
                    if (!this.enabled || !this.audioContext) return;
                    
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    // Disappointing sound (high to low frequency)
                    oscillator.frequency.setValueAtTime(400, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(150, this.audioContext.currentTime + 0.6);
                    
                    gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.15, this.audioContext.currentTime + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.6);
                    
                    oscillator.type = 'sawtooth';
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 0.6);
                };
            }
            
            createTreasureSound() {
                return () => {
                    if (!this.enabled || !this.audioContext) return;
                    
                    // Treasure sparkle sound
                    for (let i = 0; i < 5; i++) {
                        setTimeout(() => {
                            const oscillator = this.audioContext.createOscillator();
                            const gainNode = this.audioContext.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(this.audioContext.destination);
                            
                            oscillator.frequency.value = 1000 + Math.random() * 500;
                            oscillator.type = 'sine';
                            
                            gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                            gainNode.gain.linearRampToValueAtTime(0.1, this.audioContext.currentTime + 0.01);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
                            
                            oscillator.start();
                            oscillator.stop(this.audioContext.currentTime + 0.1);
                        }, i * 50);
                    }
                };
            }
            
            createClickSound() {
                return () => {
                    if (!this.enabled || !this.audioContext) return;
                    
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'square';
                    
                    gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.1, this.audioContext.currentTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
                    
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 0.1);
                };
            }
            
            createCelebrationSound() {
                return () => {
                    if (!this.enabled || !this.audioContext) return;
                    
                    // Celebration fanfare (C-E-G-C)
                    const melody = [523.25, 659.25, 783.99, 1046.50];
                    
                    melody.forEach((freq, index) => {
                        setTimeout(() => {
                            const oscillator = this.audioContext.createOscillator();
                            const gainNode = this.audioContext.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(this.audioContext.destination);
                            
                            oscillator.frequency.value = freq;
                            oscillator.type = 'triangle';
                            
                            gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                            gainNode.gain.linearRampToValueAtTime(0.2, this.audioContext.currentTime + 0.05);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.4);
                            
                            oscillator.start();
                            oscillator.stop(this.audioContext.currentTime + 0.4);
                        }, index * 200);
                    });
                };
            }
            
            playSound(soundName) {
                if (this.sounds[soundName] && this.enabled) {
                    try {
                        // Resume audio context if suspended
                        if (this.audioContext.state === 'suspended') {
                            this.audioContext.resume();
                        }
                        this.sounds[soundName]();
                    } catch (error) {
                        console.log('Sound playback error:', error);
                    }
                }
            }
            
            toggleSounds() {
                this.enabled = !this.enabled;
                return this.enabled;
            }
            
            isEnabled() {
                return this.enabled;
            }
        }

        // Treasure Chest Adventure Game - Main Game Logic
        class TreasureChestGame {
            constructor() {
                this.currentRound = 1;
                this.totalScore = 0;
                this.treasuresFound = 0;
                this.gameHistory = [];
                this.currentDifficulty = 'standard';
                
                // Game state
                this.isGameActive = true;
                this.animationInProgress = false;
                
                // Sound system
                this.soundSystem = new GameSounds();
                
                // DOM elements
                this.elements = {
                    roundCounter: document.getElementById('round-counter'),
                    totalScore: document.getElementById('total-score'),
                    treasuresFound: document.getElementById('treasures-found'),
                    instructionText: document.getElementById('instruction-text'),
                    resultDisplay: document.getElementById('result-display'),
                    resultIcon: document.getElementById('result-icon'),
                    resultTitle: document.getElementById('result-title'),
                    resultDescription: document.getElementById('result-description'),
                    rewardDisplay: document.getElementById('reward-display'),
                    continueButton: document.getElementById('continue-game'),
                    resetButton: document.getElementById('reset-game'),
                    difficultySelect: document.getElementById('difficulty'),
                    reflectionSection: document.getElementById('reflection-section'),
                    reflectionQuestion: document.getElementById('reflection-question'),
                    historyList: document.getElementById('history-list'),
                    soundToggle: document.getElementById('sound-toggle')
                };
                
                // Chest probability and reward settings
                this.chestSettings = {
                    beginner: {
                        1: { probability: 100, reward: { small: 1 }, name: 'Safe Harbor' },
                        2: { probability: 50, reward: { large: 1 }, name: 'Balanced Adventure' }
                    },
                    standard: {
                        1: { probability: 100, reward: { small: 1 }, name: 'Safe Harbor' },
                        2: { probability: 50, reward: { large: 1 }, name: 'Balanced Adventure' },
                        3: { probability: 30, reward: { large: 2 }, name: 'Big Challenge' }
                    },
                    advanced: {
                        1: { probability: 100, reward: { small: 1 }, name: 'Safe Harbor' },
                        2: { probability: 50, reward: { large: 1 }, name: 'Balanced Adventure' },
                        3: { probability: 30, reward: { large: 2 }, name: 'Big Challenge' }
                    }
                };
                
                // Reflection questions
                this.reflectionQuestions = {
                    emotional: [
                        "How did you feel when choosing the chest? Excited, nervous, or both?",
                        "How did your feelings differ when you got a treasure versus an empty chest?",
                        "What strategy would you like to try in the next round?",
                        "If you were playing with a friend, which chest would you recommend?"
                    ],
                    strategic: [
                        "Why did you choose that chest?",
                        "Would you choose the same chest again? Why or why not?",
                        "What have you learned about each of the different chests?",
                        "Is the biggest reward always the best choice? Why or why not?"
                    ],
                    conceptual: [
                        "Can you explain the difference between high and low probability chests?",
                        "What have you learned about the relationship between risk and reward?",
                        "Can you think of similar situations in real life?",
                        "What's the difference between being lucky and making wise choices?"
                    ]
                };
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.updateDisplay();
                this.updateDifficulty();
            }
            
            setupEventListeners() {
                // Chest selection buttons
                document.querySelectorAll('.chest-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const chestNumber = parseInt(e.target.dataset.chest);
                        this.selectChest(chestNumber);
                    });
                });
                
                // Chest click events
                document.querySelectorAll('.treasure-chest').forEach(chest => {
                    chest.addEventListener('click', (e) => {
                        const chestNumber = parseInt(e.target.closest('.treasure-chest').dataset.chest);
                        this.selectChest(chestNumber);
                    });
                });
                
                // Game control buttons
                this.elements.continueButton.addEventListener('click', () => {
                    this.nextRound();
                });
                
                this.elements.resetButton.addEventListener('click', () => {
                    this.resetGame();
                });
                
                this.elements.difficultySelect.addEventListener('change', (e) => {
                    this.currentDifficulty = e.target.value;
                    this.updateDifficulty();
                    this.soundSystem.playSound('click');
                });
                
                this.elements.soundToggle.addEventListener('click', () => {
                    const enabled = this.soundSystem.toggleSounds();
                    const icon = this.elements.soundToggle.querySelector('i');
                    icon.className = enabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
                });
            }
            
            updateDifficulty() {
                const difficultySettings = {
                    beginner: {
                        instruction: 'Choose one of two chests! One is safe, the other is an adventure.',
                        chests: [1, 2]
                    },
                    standard: {
                        instruction: 'Choose one of three treasure chests! Each has different rewards and probabilities.',
                        chests: [1, 2, 3]
                    },
                    advanced: {
                        instruction: 'Calculate probabilities to make the best choice! Think about expected value for wise decisions.',
                        chests: [1, 2, 3]
                    }
                };
                
                const setting = difficultySettings[this.currentDifficulty];
                this.elements.instructionText.textContent = setting.instruction;
                
                // Show/hide chests
                document.querySelectorAll('.chest-container').forEach((container, index) => {
                    const chestNumber = index + 1;
                    if (setting.chests.includes(chestNumber)) {
                        container.style.display = 'block';
                    } else {
                        container.style.display = 'none';
                    }
                });
                
                // Display expected values in advanced mode
                if (this.currentDifficulty === 'advanced') {
                    document.querySelectorAll('.chest-probability').forEach((element, index) => {
                        const chestNumber = index + 1;
                        const probability = this.chestSettings[this.currentDifficulty][chestNumber]?.probability;
                        if (probability !== undefined) {
                            element.textContent = `Success Rate: ${probability}% (Expected Value: ${this.calculateExpectedValue(chestNumber).toFixed(1)})`;
                        }
                    });
                } else {
                    document.querySelectorAll('.chest-probability').forEach((element, index) => {
                        const chestNumber = index + 1;
                        const probability = this.chestSettings[this.currentDifficulty][chestNumber]?.probability;
                        if (probability !== undefined) {
                            element.textContent = `Success Rate: ${probability}%`;
                        }
                    });
                }
            }
            
            calculateExpectedValue(chestNumber) {
                const settings = this.chestSettings[this.currentDifficulty][chestNumber];
                if (!settings) return 0;
                
                const probability = settings.probability / 100;
                let expectedValue = 0;
                
                if (settings.reward.small) {
                    expectedValue += probability * settings.reward.small * 1; // Small treasure = 1 point
                }
                if (settings.reward.large) {
                    expectedValue += probability * settings.reward.large * 2; // Large treasure = 2 points
                }
                
                return expectedValue;
            }
            
            selectChest(chestNumber) {
                if (!this.isGameActive || this.animationInProgress) return;
                
                // Check if chest exists in current difficulty
                if (!this.chestSettings[this.currentDifficulty][chestNumber]) return;
                
                this.animationInProgress = true;
                this.disableAllButtons();
                
                // Click sound
                this.soundSystem.playSound('click');
                
                // Start chest animation
                this.playChestAnimation(chestNumber).then(() => {
                    // Calculate result
                    const result = this.calculateChestResult(chestNumber);
                    
                    // Show result
                    this.showResult(result);
                    
                    // Add to history
                    this.addToHistory(result);
                    
                    // Update stats
                    this.updateStats(result);
                    
                    this.animationInProgress = false;
                });
            }
            
            async playChestAnimation(chestNumber) {
                const chest = document.getElementById(`chest-${chestNumber}`);
                
                // Chest opening sound
                this.soundSystem.playSound('chestOpen');
                
                // Chest opening animation
                chest.classList.add('opening');
                
                // Wait for animation completion
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Sparkle effect
                const glow = chest.querySelector('.chest-glow');
                glow.style.animation = 'pulse 0.5s ease-in-out 3';
                
                // Treasure sparkle sound
                this.soundSystem.playSound('treasure');
                
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Reset animation
                chest.classList.remove('opening');
                glow.style.animation = '';
            }
            
            calculateChestResult(chestNumber) {
                const settings = this.chestSettings[this.currentDifficulty][chestNumber];
                const random = Math.random() * 100;
                const success = random < settings.probability;
                
                const result = {
                    chestNumber: chestNumber,
                    chestName: settings.name,
                    success: success,
                    rewards: [],
                    totalPoints: 0
                };
                
                if (success) {
                    if (settings.reward.small) {
                        for (let i = 0; i < settings.reward.small; i++) {
                            result.rewards.push({ type: 'small', points: 1, name: 'Small Treasure' });
                            result.totalPoints += 1;
                        }
                    }
                    if (settings.reward.large) {
                        for (let i = 0; i < settings.reward.large; i++) {
                            result.rewards.push({ type: 'large', points: 2, name: 'Large Treasure' });
                            result.totalPoints += 2;
                        }
                    }
                }
                
                return result;
            }
            
            showResult(result) {
                const { resultIcon, resultTitle, resultDescription, rewardDisplay } = this.elements;
                
                // Set icons and messages based on result
                if (result.success) {
                    resultIcon.innerHTML = '🎉';
                    resultIcon.style.color = '#28a745';
                    resultTitle.textContent = 'Congratulations!';
                    resultDescription.textContent = `You found treasure in ${result.chestName}!`;
                    
                    // Success sound
                    this.soundSystem.playSound('success');
                    
                    // Celebration sound for big rewards
                    if (result.totalPoints >= 4) {
                        setTimeout(() => {
                            this.soundSystem.playSound('celebration');
                        }, 1000);
                    }
                    
                    // Display rewards with animation
                    rewardDisplay.innerHTML = result.rewards.map((reward, index) => 
                        `<div class="reward-item" style="animation-delay: ${index * 0.2}s">${reward.name} (+${reward.points} points)</div>`
                    ).join('');
                    
                    // Add particle effect
                    this.createParticleEffect();
                } else {
                    resultIcon.innerHTML = '💔';
                    resultIcon.style.color = '#dc3545';
                    resultTitle.textContent = 'Oh no!';
                    resultDescription.textContent = `${result.chestName} was empty. Try again next time!`;
                    rewardDisplay.innerHTML = '<div class="reward-item" style="background: linear-gradient(45deg, #ff9999, #ffcc99);">Empty Chest (0 points)</div>';
                    
                    // Fail sound
                    this.soundSystem.playSound('fail');
                }
                
                // Add encouragement message
                const encouragements = [
                    "That was a brave choice! 🌟",
                    "Every choice teaches us something! 📚",
                    "Keep going in the next round! 💪",
                    "Great adventurous spirit! ⭐"
                ];
                const randomEncouragement = encouragements[Math.floor(Math.random() * encouragements.length)];
                resultDescription.textContent += ` ${randomEncouragement}`;
                
                // Show result popup
                this.elements.resultDisplay.style.display = 'flex';
                
                // Prepare reflection question (30% chance)
                if (Math.random() < 0.3) {
                    setTimeout(() => {
                        this.showReflectionQuestion();
                    }, 2000);
                }
            }
            
            showReflectionQuestion() {
                const questionTypes = Object.keys(this.reflectionQuestions);
                const randomType = questionTypes[Math.floor(Math.random() * questionTypes.length)];
                const questions = this.reflectionQuestions[randomType];
                const randomQuestion = questions[Math.floor(Math.random() * questions.length)];
                
                this.elements.reflectionQuestion.textContent = randomQuestion;
                this.elements.reflectionSection.style.display = 'block';
            }
            
            addToHistory(result) {
                const historyItem = {
                    round: this.currentRound,
                    chestNumber: result.chestNumber,
                    chestName: result.chestName,
                    success: result.success,
                    points: result.totalPoints,
                    timestamp: new Date().toLocaleTimeString()
                };
                
                this.gameHistory.unshift(historyItem); // Add latest at front
                
                // Keep only 10 records
                if (this.gameHistory.length > 10) {
                    this.gameHistory.pop();
                }
                
                this.updateHistoryDisplay();
            }
            
            updateHistoryDisplay() {
                const historyList = this.elements.historyList;
                
                if (this.gameHistory.length === 0) {
                    historyList.innerHTML = '<p class="no-history">No history yet. Choose your first chest!</p>';
                    return;
                }
                
                historyList.innerHTML = this.gameHistory.map(item => {
                    const statusClass = item.success ? 'success' : 'empty';
                    const statusIcon = item.success ? '✅' : '❌';
                    const statusText = item.success ? `+${item.points} pts` : '0 pts';
                    
                    return `
                        <div class="history-item ${statusClass}">
                            <span>Round ${item.round}: ${item.chestName} ${statusIcon}</span>
                            <span>${statusText} (${item.timestamp})</span>
                        </div>
                    `;
                }).join('');
            }
            
            updateStats(result) {
                this.totalScore += result.totalPoints;
                if (result.success) {
                    this.treasuresFound += result.rewards.length;
                }
                
                this.updateDisplay();
            }
            
            updateDisplay() {
                this.elements.roundCounter.textContent = this.currentRound;
                this.elements.totalScore.textContent = this.totalScore;
                this.elements.treasuresFound.textContent = this.treasuresFound;
            }
            
            nextRound() {
                this.elements.resultDisplay.style.display = 'none';
                this.elements.reflectionSection.style.display = 'none';
                this.currentRound++;
                this.enableAllButtons();
                this.updateDisplay();
                
                // Special message every 5 rounds
                if (this.currentRound % 5 === 1 && this.currentRound > 1) {
                    this.showSpecialMessage();
                }
            }
            
            showSpecialMessage() {
                const messages = [
                    "You completed 5 rounds! Have you found any patterns? 🔍",
                    "Excellent! Keep making wise choices! 🎯",
                    "How has your strategy been so far? Want to try something new? 🤔"
                ];
                
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                this.elements.instructionText.textContent = randomMessage;
                
                setTimeout(() => {
                    this.updateDifficulty();
                }, 3000);
            }
            
            resetGame() {
                this.currentRound = 1;
                this.totalScore = 0;
                this.treasuresFound = 0;
                this.gameHistory = [];
                
                this.elements.resultDisplay.style.display = 'none';
                this.elements.reflectionSection.style.display = 'none';
                
                this.updateDisplay();
                this.updateHistoryDisplay();
                this.updateDifficulty();
                this.enableAllButtons();
                
                // Reset all chest animations
                document.querySelectorAll('.treasure-chest').forEach(chest => {
                    chest.classList.remove('opening');
                    const glow = chest.querySelector('.chest-glow');
                    glow.style.animation = '';
                });
            }
            
            disableAllButtons() {
                document.querySelectorAll('.chest-button').forEach(button => {
                    button.disabled = true;
                });
            }
            
            enableAllButtons() {
                document.querySelectorAll('.chest-button').forEach(button => {
                    button.disabled = false;
                });
            }
            
            createParticleEffect() {
                // Create particle effect in result popup
                const resultContent = document.querySelector('.result-content');
                if (!resultContent) return;
                
                for (let i = 0; i < 15; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.innerHTML = ['⭐', '✨', '🎊', '🎉', '💎'][Math.floor(Math.random() * 5)];
                    
                    // Random position
                    const x = Math.random() * 100;
                    const y = Math.random() * 100;
                    
                    particle.style.cssText = `
                        position: absolute;
                        left: ${x}%;
                        top: ${y}%;
                        font-size: 1.5rem;
                        pointer-events: none;
                        animation: particleFloat 2s ease-out forwards;
                        z-index: 1001;
                    `;
                    
                    resultContent.appendChild(particle);
                    
                    // Remove particle
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                    }, 2000);
                }
            }
        }

        // Global functions
        function showReflection() {
            if (window.game) {
                window.game.showReflectionQuestion();
            }
        }

        function hideReflection() {
            const reflectionSection = document.getElementById('reflection-section');
            reflectionSection.style.display = 'none';
        }

        function closeTutorial() {
            const tutorial = document.querySelector('.tutorial-overlay');
            if (tutorial) {
                tutorial.remove();
            }
        }

        function showGameTutorial() {
            const tutorial = document.createElement('div');
            tutorial.className = 'tutorial-overlay';
            tutorial.innerHTML = `
                <div class="tutorial-content">
                    <h2>🎮 How to Play</h2>
                    <div class="tutorial-steps">
                        <div class="tutorial-step">
                            <span class="step-number">1</span>
                            <p>Choose one of the three treasure chests</p>
                        </div>
                        <div class="tutorial-step">
                            <span class="step-number">2</span>
                            <p>Each chest has different probabilities and rewards</p>
                        </div>
                        <div class="tutorial-step">
                            <span class="step-number">3</span>
                            <p>Play multiple rounds to discover patterns</p>
                        </div>
                        <div class="tutorial-step">
                            <span class="step-number">4</span>
                            <p>Learn about the relationship between risk and reward!</p>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="closeTutorial()">Start Playing!</button>
                </div>
            `;
            
            document.body.appendChild(tutorial);
        }

        // Game initialization
        document.addEventListener('DOMContentLoaded', () => {
            window.game = new TreasureChestGame();
            
            // Show game tutorial
            setTimeout(() => {
                showGameTutorial();
            }, 1000);
        });
    </script>
</body>
</html>